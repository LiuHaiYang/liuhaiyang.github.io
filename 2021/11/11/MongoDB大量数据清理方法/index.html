<!DOCTYPE HTML>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
    <!--Setting-->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta http-equiv="Cache-Control" content="no-siteapp">
    <meta http-equiv="Cache-Control" content="no-transform">
    <meta name="renderer" content="webkit|ie-comp|ie-stand">
    <meta name="apple-mobile-web-app-capable" content="meet you">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="format-detection" content="telephone=no,email=no,adress=no">
    <meta name="browsermode" content="application">
    <meta name="screen-orientation" content="portrait">
    <link rel="dns-prefetch" href="http://yoursite.com">
    <!--SEO-->





<meta name="robots" content="all">
<meta name="google" content="all">
<meta name="googlebot" content="all">
<meta name="verify" content="all">
    <!--Title-->


<title>MongoDB大量数据清理方法 | meet you</title>


    <link rel="alternate" href="/atom.xml" title="meet you" type="application/atom+xml">


    <link rel="icon" href="/img/favicon.ico">

    


    <link rel="stylesheet" href="//imsun.github.io/gitment/style/default.css">


<link rel="stylesheet" href="/css/bootstrap.min.css?rev=3.3.7">
<link rel="stylesheet" href="/css/font-awesome.min.css?rev=4.5.0">
<link rel="stylesheet" href="/css/style.css?rev=@@hash">




    


    

</head>

</html>
<!--[if lte IE 8]>
<style>
    html{ font-size: 1em }
</style>
<![endif]-->
<!--[if lte IE 9]>
<div style="ie">你使用的浏览器版本过低，为了你更好的阅读体验，请更新浏览器的版本或者使用其他现代浏览器，比如Chrome、Firefox、Safari等。</div>
<![endif]-->

<body>
    <header class="main-header"  style="background-image:url(http://snippet.shenliyang.com/img/banner.jpg)"  >
    <div class="main-header-box">
        <a class="header-avatar" href="/" title='Ocean'>
            <img src="/img/avatar.jpg" alt="logo头像" class="img-responsive center-block">
        </a>
        <div class="branding">
        	<!--<h2 class="text-hide">Snippet主题,从未如此简单有趣</h2>-->
            
                <h2> Always believe youself. </h2>
            
    	</div>
    </div>
</header>
    <nav class="main-navigation">
    <div class="container">
        <div class="row">
            <div class="col-sm-12">
                <div class="navbar-header"><span class="nav-toggle-button collapsed pull-right" data-toggle="collapse" data-target="#main-menu" id="mnav">
                    <span class="sr-only"></span>
                        <i class="fa fa-bars"></i>
                    </span>
                    <a class="navbar-brand" href="http://yoursite.com">meet you</a>
                </div>
                <div class="collapse navbar-collapse" id="main-menu">
                    <ul class="menu">
                        
                            <li role="presentation" class="text-center">
                                <a href="/"><i class="fa "></i>首页</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/tags/python/"><i class="fa "></i>python</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/tags/java/"><i class="fa "></i>JAVA</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/tags/生活/"><i class="fa "></i>生活</a>
                            </li>
                        
                            <li role="presentation" class="text-center">
                                <a href="/archives/"><i class="fa "></i>时间轴</a>
                            </li>
                        
                    </ul>
                </div>
            </div>
        </div>
    </div>
</nav>
    <section class="content-wrap">
        <div class="container">
            <div class="row">
                <main class="col-md-8 main-content m-post">
                    <p id="process"></p>
<article class="post">
    <div class="post-head">
        <h1 id="MongoDB大量数据清理方法">
            
	            MongoDB大量数据清理方法
            
        </h1>
        <div class="post-meta">
    
    
    <span class="categories-meta fa-wrap">
        <i class="fa fa-folder-open-o"></i>
        <a href="/categories/ ">
             
        </a>
    </span>
    
    
    <span class="fa-wrap">
        <i class="fa fa-tags"></i>
        <span class="tags-meta">
            
                
                    <a href="/tags/数据库" title='数据库'>
                        数据库
                    </a>
                
            
        </span>
    </span>
    

    
        
        <span class="fa-wrap">
            <i class="fa fa-clock-o"></i>
            <span class="date-meta">2021/11/11</span>
        </span>
    
</div>

            
            
    </div>
    
    <div class="post-body post-content">
        <h2 id="方法"><a href="#方法" class="headerlink" title="方法"></a>方法</h2><h3 id="TTL-Index"><a href="#TTL-Index" class="headerlink" title="TTL Index"></a>TTL Index</h3><p>TTL index是一种带有过期时间属性的索引，在时间类型的字段上（确定的值或者时间数组），数据插入的时候会根据索引字段的值确定数据保留时间，当超时后，mongodb后台线程会自动清理过期的文档，默认每60秒线程启动一次。</p>
<p>TTL index有以下特点：</p>
<ul>
<li>单列索引</li>
<li>自动计算过期时间</li>
<li>索引字段是数组，会根据数组中最早的时间加保留时长计算过期时间</li>
<li>索引字段不包含时间类型数据不会自动删除，不包含索引字段的文档也不会自动删除</li>
<li>保留时长修改需要使用collMod</li>
<li>不能在已有单列索引的字段上创建TTL index</li>
</ul>
<p>创建索引</p>
<p>  db.eventlog.createIndex( { “lastModifiedDate”: 1 }, { expireAfterSeconds: 3600 } )</p>
<p>修改时间</p>
<h1 id="修改索引的时间为10s"><a href="#修改索引的时间为10s" class="headerlink" title="修改索引的时间为10s"></a>修改索引的时间为10s</h1><p>  db.runCommand({collMod: “mycoll”,index: {keyPattern: {“borthday”: 1},expireAfterSeconds: 10}})</p>
<h3 id="capped-collection"><a href="#capped-collection" class="headerlink" title="capped collection"></a>capped collection</h3><p>capped collection 是一种固定大小的集合，数据按照插入顺序存储，数据插入时，自动覆盖最旧的数据。类似滚动日志的写入方式。</p>
<p>capped collection 具有以下特点：</p>
<ul>
<li>固定大小，自动删除数据</li>
<li>默认只有_id字段的索引，插入速度快</li>
<li>update 操作不能修改文档的大小</li>
<li>可以通过索引加快查询速度</li>
<li>不能使用remove/delete*操作</li>
</ul>
<p>创建capped collection</p>
<pre><code>db.createCollection( &quot;log&quot;, { capped: true, size: 100000 } )
</code></pre><p>指定size又指定集合数</p>
<pre><code>db.createCollection(&quot;log&quot;, { capped : true, size : 5242880, max : 5000 } )
</code></pre><h3 id="drop"><a href="#drop" class="headerlink" title="drop"></a>drop</h3><p>针对不再使用的集合，可以使用drop直接删除，该操作会删除集合、数据和索引。</p>
<p>该操作会在操作的数据库上获取一个block lock，操作期间会阻塞其他操作。<br>导出数据–rename 集合–导入数据–drop原来的集合，通过此方式清理数据可以达到回收空间的目的。</p>
<h3 id="remove"><a href="#remove" class="headerlink" title="remove"></a>remove</h3><p>remove 操纵时mongo shell 的操作命令，使用的时delete 命令操作数据。<br>remove有两种操作方式</p>
<pre><code>db.collection.remove(
   &lt;query&gt;,
   &lt;justOne&gt;
)
或
db.collection.remove(
   &lt;query&gt;,
   {
     justOne: &lt;boolean&gt;,
     writeConcern: &lt;document&gt;,
     collation: &lt;document&gt;
   }
)

删除所有数据
db.bios.remove( { } )
根据查询删除数据
db.products.remove( { qty: { $gt: 20 } } ) //删除所有符合条件的数据
db.products.remove( { qty: { $gt: 20 } }, true ) // 只删除一条符合条件的数据

待条件删除
db.products.remove(
    { qty: { $gt: 20 } },
    { writeConcern: { w: &quot;majority&quot;, wtimeout: 5000 } }
)

3.4 版之后，还可以根据键盘规则和重音删除数据（不常用）
db.myColl.remove(
   { category: &quot;cafe&quot;, status: &quot;A&quot; },
   { collation: { locale: &quot;fr&quot;, strength: 1 } }
)
</code></pre><h3 id="deleteOne-deleteMany"><a href="#deleteOne-deleteMany" class="headerlink" title="deleteOne/deleteMany"></a>deleteOne/deleteMany</h3><p>两个mongo shell 方法，删除一条或者多条数据，是remove 的底层函数。<br>可以指定条件删除数据，mongo 4.4 之后的版本可以指定hint，通过索引加快数据删除。</p>
<p>以下以deleteMany为例，deleteOne类似</p>
<p>语法：</p>
<pre><code>db.collection.deleteMany(
   &lt;filter&gt;,
   {
      writeConcern: &lt;document&gt;,
      collation: &lt;document&gt;
   }
)
</code></pre><h3 id="根据-id-删除过期数据"><a href="#根据-id-删除过期数据" class="headerlink" title="根据_id 删除过期数据"></a>根据_id 删除过期数据</h3><p>集合的_id字段是默认自动生成，类型时objectid。在数据插入时，如果不指定_id的值，该字段默认会按照时间先后顺序生成的字符串插入。默认的格式为：</p>
<p>4 字节 timestamp<br>3 字节 机器id<br>2 字节 执行插入的process id<br>3 字节的自增数字</p>
<p>因此，可以通过按照执行时间生成的objectid 删除数据。</p>
<pre><code>function timeToObjId( time ) {
    var t = new Date(time);
    t = t.getTime()/1000; // 转换成秒数
    return t.toString(16)+&apos;0000000000000000&apos;; // 转换成16进制的字符串，再加补齐16个0
}

var objIdTimeTo = timeToObjId( &apos;2020-08-25 10:42:01&apos; );

// 查询MongoDB数据库

&apos;&apos;&apos;
  var objid=db.test.find({
  &quot;\_id&quot;: {
          &apos;$lt&apos;: ObjectId( objIdTimeto )
      },{&quot;\_id&quot; :1}).limit(5000);
  while (objid.hasNext()){
    var obj=objid.next().\_id;
    db.test.remove({&quot;\_id&quot;: obj});
  }
&apos;&apos;&apos;
</code></pre><h2 id="大量数据删除"><a href="#大量数据删除" class="headerlink" title="大量数据删除"></a>大量数据删除</h2><p>在清理大量数据时，很容易造成实例性能下降或阻塞操作等问题，接下来，根据不同的场景讨论一下如何合理的清理大量数据。</p>
<h3 id="只写少读或者不读的集合"><a href="#只写少读或者不读的集合" class="headerlink" title="只写少读或者不读的集合"></a>只写少读或者不读的集合</h3><p>这种集合一般是日志，状态等信息，一般情况下不会读取，之后在少数情况下使用，但是平时场景中，此类型数据量巨大<br>这种情况下，一般可以考虑使用capped 或者ttl ，对于集合中已有的数据，可以考虑rename，然后等待旧的表中的所有数据过期后，drop集合。</p>
<h3 id="读写频繁的集合"><a href="#读写频繁的集合" class="headerlink" title="读写频繁的集合"></a>读写频繁的集合</h3><p>这种集合是日常场景中最常见的，基本上要保持集合实时在线可访问，但该类型又可分为以下两种情况：</p>
<ul>
<li><p>有时间字段<br>如果有时间字段，且业务要求按照时间字段清理数据，可以考虑清理一次后，创建ttl索引。</p>
</li>
<li><p>无时间字段<br>由于集合中没有时间字段，无法通过业务字段按照时间维度清理，此时分两种情况：</p>
</li>
<li><p>_id 自动生成<br>参考根据_id 删除过期数据</p>
</li>
<li><p>_id 由程序写入<br>此情况需要研发确定规则清理数据。</p>
</li>
</ul>
<h3 id="分批删除"><a href="#分批删除" class="headerlink" title="分批删除"></a>分批删除</h3><p>在根据时间字段和_id进行删除时，需要分批进行，例如：</p>
<ul>
<li><p>时间字段是递增的，可以使用循环，进行分批删除</p>
<p>  for (var i = 1358758292145; i &lt;= 1558758292170; i=i+158758292145){<br>  db.attribute_all.deleteMany( {“timestamp”: {$gte:NumberLong(“1358758292145”),$lt: NumberLong(i)} } )<br>  }</p>
</li>
<li><p>回收空间</p>
</li>
</ul>
<p>上面列举了不同的数据清理方法，其中TTL index 和 capped collection的方式维护成本较低，capped 是固定大小集合，不会存在收缩数据文件的情况；TTL index根据时间字段删除数据，只要数据插入时存在时间字段，数据文件的增长依然可控。同时两种方案一般不会出现短时间内大量删除数据造成性能低下的问题。</p>
<p>！注意: 如果在较大的集合上创建TTL index ，需要注意过期数据的大小，创建集合后，已过期的数据会被自动清理。</p>
<p>使用remove 和 delete类方法清理数据后，数据文件不会自动收缩，需要额外的处理来回收空间。</p>
<p>常用的空间回收操作有以下几种：</p>
<ul>
<li>compact</li>
<li>db.repairDatabase()</li>
<li>db.copyDatabase()</li>
<li>secondary 同步</li>
<li>rename+export/import</li>
</ul>
<h3 id="compact"><a href="#compact" class="headerlink" title="compact"></a>compact</h3><p>该操作会重写集合中的数据和集合上的索引数据，减少碎片，回收空间。</p>
<pre><code>rs0:PRIMARY&gt; db.test.find({ \_id:{ $lt : ObjectId(&quot;5f47766051a43a0011aa19e9&quot;)} }).count()
1061370 # 符合删除条件的文档数
rs0:PRIMARY&gt; db.test.count()
1125827 #总的文档数
</code></pre><p>回收前，数据文件的大小</p>
<pre><code>&quot;file size in bytes&quot; : 66174976,

-rw-r--r--. 1 root root  64M Aug 27 17:09 collection-7--5205033096240673155.wt
</code></pre><p>数据清理后，数据占用的大小为”size” : 23913583,</p>
<p>使用compact，回收空间：</p>
<pre><code>db.runCommand({compact: &quot;test&quot;,force:true})
</code></pre><p>回收后文件大小-rw-r–r–. 1 root root 3.5M Aug 27 17:16 collection-7–5205033096240673155.wt</p>
<p>特点：</p>
<ul>
<li>会在操作的数据库上加锁 ，阻塞其他操作</li>
<li>集合较大时，执行时间长</li>
</ul>
<h3 id="db-repairDatabase"><a href="#db-repairDatabase" class="headerlink" title="db.repairDatabase()"></a>db.repairDatabase()</h3><p>repair 操作主要作用是修复逻辑损坏的数据，一般在数据库异常终止之后使用，该操作会删除损坏或不可用的数据，并重建索引。该操作直接重新整理数据，所以可以达到释放空间的效果。</p>
<p>使用方法：</p>
<pre><code>#启动mongo 的时候使用
mongod --repair

#或使用命令
db.runCommand( { repairDatabase: 1 } )
</code></pre><p>特点：</p>
<ul>
<li>执行时获取全局锁，阻塞其他操作</li>
<li>空间需求，集合大小+2G</li>
<li>丢弃损坏的数据，重建索引</li>
</ul>
<h3 id="db-copyDatabase"><a href="#db-copyDatabase" class="headerlink" title="db.copyDatabase()"></a>db.copyDatabase()</h3><p>拷贝数据库，可以从一个实例拷贝指定的数据库到另外一个实例，同实例可以进行拷贝。</p>
<p>同实例拷贝：</p>
<pre><code>db.copyDatabase(&apos;records&apos;, &apos;archive_records&apos;)
</code></pre><p>特点：</p>
<ul>
<li>拷贝期间不锁定目标实例，可以进行其他操作</li>
<li>重建索引使用foreground形式创建，会阻塞所有其他操作</li>
<li>拷贝过程中，会出现数据不一致</li>
</ul>
<h3 id="secondary-同步"><a href="#secondary-同步" class="headerlink" title="secondary 同步"></a>secondary 同步</h3><p>操作步骤，参考副本重新同步</p>
<p>特点：</p>
<ul>
<li>需要有副本集架构</li>
<li>不阻塞实例，但是重新同步的过程中，需要注意IO</li>
</ul>
<h3 id="rename-export-import"><a href="#rename-export-import" class="headerlink" title="rename+export/import"></a>rename+export/import</h3><p>首先，rename原集合</p>
<pre><code>use admin
db.runCommand({renameCollection: &quot;test.test&quot;,to :&quot;test.test_bak&quot;})
</code></pre><p>然后，导出rename之后的数据</p>
<pre><code>mongoexport -d test -c test_bak -o test_bak.json
</code></pre><p>导入到新集合中</p>
<pre><code>mongoimport -d test -c test --file=test_bak.json
</code></pre><p>最后，删除备份的集合</p>
<pre><code>db.test_bak.drop()
</code></pre><p>！注意<br>该操作只适合并发量较小，且允许短时间内无法读取旧数据的场景。</p>

    </div>

    <div class="post-footer">
        <div>
            
                转载声明：商业转载请联系作者获得授权,非商业转载请注明出处 ,图片资源转自pexels © <a href="" target="_blank">Ocean</a>
            
        </div>
        <div>
            
        </div>
    </div>
</article>

<div class="article-nav prev-next-wrap clearfix">
    
        <a href="/2021/11/18/clickhouse索引详解/" class="pre-post btn btn-default" title='clickhouse索引详解'>
            <i class="fa fa-angle-left fa-fw"></i><span class="hidden-lg">上一篇</span>
            <span class="hidden-xs">clickhouse索引详解</span>
        </a>
    
    
        <a href="/2021/11/10/git分支命名规范/" class="next-post btn btn-default" title='git分支命名规范'>
            <span class="hidden-lg">下一篇</span>
            <span class="hidden-xs">git分支命名规范</span><i class="fa fa-angle-right fa-fw"></i>
        </a>
    
</div>


    <div id="comments">
        
	<link rel="stylesheet" href="https://jjeejj.github.io/css/gitment.css">
<script src="https://jjeejj.github.io/js/gitment.js"></script>

<script>
    var gitment = new Gitment({
        id: 'Thu Nov 11 2021 18:32:40 GMT+0800',
        owner:"LiuHaiYang",
        repo:"liuhaiyang.github.io",
        oauth: {
          client_id:"aacf4f5555aee5bf0770",
          client_secret:"07f91d5b66c30419c14d14349ccadaa91300bc9c"
        },
        perPage:"10",
    });
    gitment.render('comments');
</script>

    </div>





                </main>
                
                    <aside id="article-toc" role="navigation" class="col-md-4">
    <div class="widget">
        <h3 class="title">文章目录</h3>
        
            <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#方法"><span class="toc-text">方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#TTL-Index"><span class="toc-text">TTL Index</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#修改索引的时间为10s"><span class="toc-text">修改索引的时间为10s</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#capped-collection"><span class="toc-text">capped collection</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#drop"><span class="toc-text">drop</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#remove"><span class="toc-text">remove</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#deleteOne-deleteMany"><span class="toc-text">deleteOne/deleteMany</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#根据-id-删除过期数据"><span class="toc-text">根据_id 删除过期数据</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#大量数据删除"><span class="toc-text">大量数据删除</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#只写少读或者不读的集合"><span class="toc-text">只写少读或者不读的集合</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#读写频繁的集合"><span class="toc-text">读写频繁的集合</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分批删除"><span class="toc-text">分批删除</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#compact"><span class="toc-text">compact</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#db-repairDatabase"><span class="toc-text">db.repairDatabase()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#db-copyDatabase"><span class="toc-text">db.copyDatabase()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#secondary-同步"><span class="toc-text">secondary 同步</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rename-export-import"><span class="toc-text">rename+export/import</span></a></li></ol></li></ol>
        
    </div>
</aside>

                
            </div>
        </div>
    </section>
    <footer class="main-footer">
    <div class="container">
        <div class="row">
        </div>
    </div>
</footer>

<a id="back-to-top" class="icon-btn hide">
	<i class="fa fa-chevron-up"></i>
</a>




    <div class="copyright">
    <div class="container">
        <div class="row">
            <div class="col-sm-12"> 
                <span>Copyright &copy; 2019
                </span> | 
                <span>
                    Powered by <a href="//hexo.io" class="copyright-links" target="_blank" rel="nofollow">Ocean</a>
                </span> | 
                <span>
                    Theme by <a href="//github.com/shenliyang/hexo-theme-snippet.git" class="copyright-links" target="_blank" rel="nofollow">Snippet</a>
                </span>
            </div>
        </div>
    </div>
</div>



<script src="/js/app.js?rev=@@hash"></script>


</body>
</html>